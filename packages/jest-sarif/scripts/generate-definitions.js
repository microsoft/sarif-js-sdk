const fs = require('fs');
const path = require('path');
const { EOL } = require('os');
const fetch = require('sync-fetch');
const prettier = require('prettier');
const sarifSchema = fetch(
  'https://schemastore.azurewebsites.net/schemas/json/sarif-2.1.0-rtm.5.json'
).json();
const definitions = Object.keys(sarifSchema.definitions);
const definitionsPath = path.join(__dirname, '..', 'src', 'types', 'definitions.ts');
const definitionsSource = `
  // THIS IS AN AUTOGENERATED FILE. DO NOT EDIT THIS FILE DIRECTLY.

  export type Definitions = ${definitions.map((definition) => `"${definition}"`).join(` | ${EOL}`)};
`;

/**
 * Dynamically builds TypeScript definitions for SARIF definitions.
 */
prettier.resolveConfig(definitionsPath).then((options) => {
  const formatted = prettier.format(
    definitionsSource,
    Object.assign({}, { parser: 'babel' }, options)
  );

  fs.writeFileSync(definitionsPath, formatted);
});
