const fs = require('fs');
const path = require('path');
const { EOL } = require('os');
const fetch = require('sync-fetch');
const prettier = require('prettier');

const AUTOGENERATED_HEADER = '// THIS IS AN AUTOGENERATED FILE. DO NOT EDIT THIS FILE DIRECTLY.';
const sarifSchema = fetch(
  'https://schemastore.azurewebsites.net/schemas/json/sarif-2.1.0-rtm.5.json'
).json();
const definitions = Object.keys(sarifSchema.definitions);

function generateDefinitions() {
  const definitionPath = path.join(__dirname, '..', 'src', 'types', 'definition.ts');
  const definitionSource = `
  ${AUTOGENERATED_HEADER}

  export type Definition = ${definitions.map((definition) => `"${definition}"`).join(` | ${EOL}`)};
`;

  writeFile(definitionPath, definitionSource);
}

function writeFile(filePath, contents, prettierOptions = {}) {
  const mergedPrettierOptions = Object.assign({}, { parser: 'babel-ts' }, prettierOptions);

  prettier.resolveConfig(filePath).then((options) => {
    const formatted = prettier.format(contents, Object.assign({}, mergedPrettierOptions, options));

    fs.writeFileSync(filePath, formatted);
  });
}

generateDefinitions();
